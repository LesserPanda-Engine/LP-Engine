<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Lesser Panda Source: tilemap/background-map.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.flatly.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Lesser Panda</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="module-engine_actor.html">engine/actor</a></li><li><a href="module-engine_analytics.html">engine/analytics</a></li><li><a href="module-engine_animation.html">engine/animation</a></li><li><a href="module-engine_animation_action.html">engine/animation/action</a></li><li><a href="module-engine_animation_easing.html">engine/animation/easing</a></li><li><a href="module-engine_animation_tween.html">engine/animation/tween</a></li><li><a href="module-engine_animation_utils.html">engine/animation/utils</a></li><li><a href="module-engine_audio.html">engine/audio</a></li><li><a href="module-engine_behavior.html">engine/behavior</a></li><li><a href="module-engine_camera.html">engine/camera</a></li><li><a href="module-engine_core.html">engine/core</a></li><li><a href="module-engine_device.html">engine/device</a></li><li><a href="module-engine_eventemitter3.html">engine/eventemitter3</a></li><li><a href="module-engine_keyboard.html">engine/keyboard</a></li><li><a href="module-engine_level_tiled-converter.html">engine/level/tiled-converter</a></li><li><a href="module-engine_level_utils.html">engine/level/utils</a></li><li><a href="module-engine_loader.html">engine/loader</a></li><li><a href="module-engine_physics.html">engine/physics</a></li><li><a href="module-engine_physics_spatial-hash.html">engine/physics/spatial-hash</a></li><li><a href="module-engine_renderer.html">engine/renderer</a></li><li><a href="module-engine_resize.html">engine/resize</a></li><li><a href="module-engine_rnd.html">engine/rnd</a></li><li><a href="module-engine_scene.html">engine/scene</a></li><li><a href="module-engine_storage.html">engine/storage</a></li><li><a href="module-engine_storage_data.html">engine/storage/data</a></li><li><a href="module-engine_storage_persistent-data.html">engine/storage/persistent-data</a></li><li><a href="module-engine_tilemap_background-map.html">engine/tilemap/background-map</a></li><li><a href="module-engine_tilemap_filmstrip.html">engine/tilemap/filmstrip</a></li><li><a href="module-engine_tilemap_tile-renderer.html">engine/tilemap/tile-renderer</a></li><li><a href="module-engine_timer.html">engine/timer</a></li><li><a href="module-engine_utils.html">engine/utils</a></li><li><a href="module-engine_vector.html">engine/vector</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="Actor.html">Actor</a></li><li><a href="Analytics.html">Analytics</a></li><li><a href="BackgroundMap.html">BackgroundMap</a></li><li><a href="Behavior.html">Behavior</a></li><li><a href="Camera.html">Camera</a></li><li><a href="CollisionMap.html">CollisionMap</a></li><li><a href="Data.html">Data</a></li><li><a href="EventEmitter.html">EventEmitter</a></li><li><a href="Keyboard.html">Keyboard</a></li><li><a href="module-engine_animation_action-Action.html">engine/animation/action~Action</a></li><li><a href="module-engine_animation_action-ActionPlayer.html">engine/animation/action~ActionPlayer</a></li><li><a href="module-engine_animation_action-Channel.html">engine/animation/action~Channel</a></li><li><a href="module-engine_animation_action-Key.html">engine/animation/action~Key</a></li><li><a href="module-engine_physics-AABBSolver.html">engine/physics~AABBSolver</a></li><li><a href="module-engine_physics-Body.html">engine/physics~Body</a></li><li><a href="module-engine_physics-Box.html">engine/physics~Box</a></li><li><a href="module-engine_physics-Circle.html">engine/physics~Circle</a></li><li><a href="module-engine_physics-Polygon.html">engine/physics~Polygon</a></li><li><a href="module-engine_physics-SATSolver.html">engine/physics~SATSolver</a></li><li><a href="module-engine_physics-World.html">engine/physics~World</a></li><li><a href="PersistentData.html">PersistentData</a></li><li><a href="RandomDataGenerator.html">RandomDataGenerator</a></li><li><a href="Scene.html">Scene</a></li><li><a href="SpatialHash.html">SpatialHash</a></li><li><a href="Storage.html">Storage</a></li><li><a href="Timer.html">Timer</a></li><li><a href="Tween.html">Tween</a></li><li><a href="Vector.html">Vector</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: tilemap/background-map.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">'use strict';

var PIXI = require('engine/pixi');
var core = require('engine/core');
var utils = require('engine/utils');

var TileRenderer = require('./tile-renderer');
PIXI.WebGLRenderer.registerPlugin('tile', TileRenderer);

var matrixArrayCache = new Float32Array(9);

/**
 * TileMap for rendering rectangle tile based maps.
 *
 * Based on PIXI-tilemap by Ivan Popelyshev
 * Modified by Sean Bohan.
 *
 * @class BackgroundMap
 *
 * @constructor
 */
function BackgroundMap(tilesize, data, tileset) {
  PIXI.Container.call(this);

  /**
   * Size of each tile
   * @type {number}
   */
  this.tilesize = tilesize;
  /**
   * Tileset of this map
   * @type {PIXI.Texture}
   */
  this.tileset = tileset;
  /**
   * Map data, a 2D array
   * @type {Array}
   */
  this.data = [[]];

  /**
   * Whether this map wraps at the edges.
   * @type {Boolean}
   */
  this.isRepeat = false;

  /**
   * Whether tile is square(width = height). Performance of squared
   * tiles is better than non-squared ones.
   *
   * Note: Currently only squared tiles are supported.
   *
   * @type {Boolean}
   */
  this.useSquare = true;

  /**
   * Points buffer for rendering
   * @type {Array}
   * @private
   */
  this.pointsBuf = new Array(512);
  /**
   * Marker that shows whether the rendering buffers need update
   * @type {Number}
   * @private
   */
  this.modificationMarker = 0;

  this.uOffset = tileset.frame.x;
  this.vOffset = tileset.frame.y;
  this.tilesPerTilesetRow = Math.floor(tileset.width / tilesize);

  this.tilesInRenderBuffer = 0;
  this.lastCornerCoord = { tlq: 0, tlr: 0, brq: 0, brr: 0 };

  this.globalMat = new PIXI.Matrix();

  this.setData(data);
}

BackgroundMap.prototype = Object.create(PIXI.Container.prototype);
BackgroundMap.prototype.constructor = BackgroundMap;

Object.defineProperties(BackgroundMap.prototype, {
  /**
   * Width of this map in pixel.
   * @memberof BackgroundMap#
   * @readonly
   */
  width: {
    get: function() {
      return this.widthInTile * this.tilesize;
    },
  },
  /**
   * Height of this map in pixel.
   * @memberof BackgroundMap#
   * @readonly
   */
  height: {
    get: function() {
      return this.heightInTile * this.tilesize;
    },
  },
  /**
   * Width of this map in tile.
   * @memberof BackgroundMap#
   * @readonly
   */
  widthInTile: {
    get: function() {
      if (Array.isArray(this.data) &amp;&amp; (this.data.length > 0) &amp;&amp; Array.isArray(this.data[0])) {
        return this.data[0].length;
      }
      else {
        return 0;
      }
    },
  },
  /**
   * Height of this map in tile.
   * @memberof BackgroundMap#
   * @readonly
   */
  heightInTile: {
    get: function() {
      if (Array.isArray(this.data)) {
        return this.data.length;
      }
      else {
        return 0;
      }
    },
  },
});

/**
 * Set new data to this map.
 * @memberof BackgroundMap#
 * @method setData
 * @param {Array} data New map data.
 */
BackgroundMap.prototype.setData = function(data) {
  this.data = data;
  this.modificationMarker = 0;
};

/**
 * Set the tile at the pixel coordinates.
 * @param {number} x
 * @param {number} y
 * @param {number} tileIdx New tile index
 */
BackgroundMap.prototype.setTile = function(x, y, tileIdx) {
  if (x &lt; 0 || x > this.widthInTile * this.tilesize || y &lt; 0 || y > this.heightInTile * this.tilesize) {
    console.log('Cannot set a tile since the coordinate is out of range!');
    return;
  }

  // Calculate tile coordinate
  var tx = Math.floor(x / this.tilesize);
  var ty = Math.floor(y / this.tilesize);

  // Update map data
  this.data[ty][tx] = tileIdx;

  // Request buffer re-upload
  this.modificationMarker = 0;
};

/**
 * Get the tile at pixel coordinates.
 * @param  {number} x
 * @param  {number} y
 * @return {number}   Tile at the coordinates, 0 if no one is found.
 */
BackgroundMap.prototype.getTile = function(x, y) {
  if (x &lt; 0 || x > this.widthInTile * this.tilesize || y &lt; 0 || y > this.heightInTile * this.tilesize) {
    return 0;
  }

  // Calculate tile coordinate
  var tx = Math.floor(x / this.tilesize);
  var ty = Math.floor(y / this.tilesize);

  return this.data[ty][tx];
};

/**
 * Clear the map
 * @memberof BackgroundMap#
 * @method clear
 */
BackgroundMap.prototype.clear = function() {
  this.data = [[]];
  this.modificationMarker = 0;
};

/**
 * Update transform of this map.
 * @memberof BackgroundMap#
 * @method updateTransform
 */
BackgroundMap.prototype.updateTransform = function() {
  BackgroundMap.prototype.displayObjectUpdateTransform.call(this);

  this.updateRenderTileBuffer();
};

BackgroundMap.prototype.updateRenderTileBuffer = function() {
  var topLeftX = -this.worldTransform.tx;
  var topLeftY = -this.worldTransform.ty;

  var bottomRightX = topLeftX + core.width;
  var bottomRightY = topLeftY + core.height;

  var topLeftQ = this.getColAt(topLeftX);
  var topLeftR = this.getRowAt(topLeftY);

  var bottomRightQ = this.getColAt(bottomRightX);
  var bottomRightR = this.getRowAt(bottomRightY);

  var tilesPerRow = Math.ceil(core.width / this.tilesize);
  var tilesPerCol = Math.ceil(core.height / this.tilesize);

  var tilesToRender = tilesPerRow * tilesPerCol;
  var needUpdateRTB = (this.modificationMarker === 0);

  // Check whether tile to be rendered changes
  if (tilesToRender !== this.tilesInRenderBuffer) {
    this.tilesInRenderBuffer = tilesToRender;

    // Resize the point buffer for rendering
    this.pointsBuf.length = tilesToRender * 6;

    // Render point buffer needs update
    needUpdateRTB = true;
  }

  // Check whether cornor tile coord changes
  if (this.lastCornerCoord.tlq !== topLeftQ || this.lastCornerCoord.tlr !== topLeftR ||
    this.lastCornerCoord.brq !== bottomRightQ || this.lastCornerCoord.brr !== bottomRightR) {
    this.lastCornerCoord.tlq = topLeftQ;
    this.lastCornerCoord.tlr = topLeftR;
    this.lastCornerCoord.brq = bottomRightQ;
    this.lastCornerCoord.brr = bottomRightR;

    // Render point buffer needs update
    needUpdateRTB = true;
  }

  // Update render tile buffer if required
  if (needUpdateRTB) {
    var r, q, nr, nq, maxR, maxQ, tileIdx, pb = this.pointsBuf, index = 0, widthInTile = this.widthInTile, heightInTile = this.heightInTile;
    maxR = Math.min(topLeftR + tilesPerCol + 1, heightInTile);
    maxQ = Math.min(topLeftQ + tilesPerRow + 1, widthInTile);
    for (r = topLeftR - 1; r &lt; topLeftR + tilesPerCol + 1; r++) {
      for (q = topLeftQ - 1; q &lt; topLeftQ + tilesPerRow + 1; q++) {
        tileIdx = -1;

        if (this.isRepeat) {
          // Normalize row and column
          nr = (r &lt; 0) ? (r % heightInTile + heightInTile) : (r % heightInTile);
          if (nr === heightInTile) nr = 0;
          nq = (q &lt; 0) ? (q % widthInTile + widthInTile) : (q % widthInTile);
          if (nq === widthInTile) nq = 0;

          // Read tileIdx from map data
          tileIdx = this.data[nr][nq] - 1;
        }
        // Not repeat and within the range
        else if (r > -1 &amp;&amp; q > -1 &amp;&amp; r &lt; maxR &amp;&amp; q &lt; maxQ) {
          tileIdx = this.data[r][q] - 1;
        }

        if (tileIdx >= 0) {
          pb[index++] = this.uOffset + this.tilesize * Math.floor(tileIdx % this.tilesPerTilesetRow);
          pb[index++] = this.vOffset + this.tilesize * Math.floor(tileIdx / this.tilesPerTilesetRow);
          pb[index++] = this.tilesize * q;
          pb[index++] = this.tilesize * r;
          pb[index++] = this.tilesize;
          pb[index++] = this.tilesize;
        }
        else {
          pb[index++] = 0;
          pb[index++] = 0;
          pb[index++] = 0;
          pb[index++] = 0;
          pb[index++] = 0;
          pb[index++] = 0;
        }
      }
    }

    // Mark as modified
    this.modificationMarker = 0;
  }
};

/**
 * Get the tile column at a x location
 * @memberof BackgroundMap#
 * @method getColAt
 * @param  {number} x Location to be tested
 * @return {number}
 */
BackgroundMap.prototype.getColAt = function(x) {
  if (this.isRepeat) {
    return Math.floor(x / this.tilesize);
  }
  else {
    return utils.clamp(Math.floor(x / this.tilesize), 0, this.widthInTile - 1);
  }
};

/**
 * Get the tile row at a y location
 * @memberof BackgroundMap#
 * @method getRowAt
 * @param  {number} y Location to be tested
 * @return {number}
 */
BackgroundMap.prototype.getRowAt = function(y) {
  if (this.isRepeat) {
    return Math.floor(y / this.tilesize);
  }
  else {
    return utils.clamp(Math.floor(y / this.tilesize), 0, this.heightInTile - 1);
  }
};

/**
 * Render to canvas context
 * @memberof BackgroundMap#
 * @method renderCanvas
 * @private
 */
BackgroundMap.prototype.renderCanvas = function(renderer) {
  if (!renderer.dontUseTransform) {
    var wt = this.worldTransform;
    renderer.context.setTransform(
      wt.a * renderer.resolution,
      wt.b,
      wt.c,
      wt.d * renderer.resolution,
      wt.tx * renderer.resolution,
      wt.ty * renderer.resolution
    );
  }

  if (!this.tileset || !this.tileset.valid) return;
  var points = this.pointsBuf;
  for (var i = 0, n = points.length; i &lt; n; i += 6) {
    var x1 = points[i], y1 = points[i+1];
    var x2 = points[i+2], y2 = points[i+3];
    var w = points[i+4];
    var h = points[i+5];
    renderer.context.drawImage(this.tileset.baseTexture.source, x1, y1, w, h, x2, y2, w, h);
  }
};

/**
 * Render to WebGL context
 * @memberof BackgroundMap#
 * @method renderWebGL
 * @private
 */
BackgroundMap.prototype.renderWebGL = function(renderer) {
  var gl = renderer.gl;
  var tile = renderer.plugins.tile;
  var shader = tile.getShader(this.useSquare);
  renderer.setObjectRenderer(renderer.plugins.tile);
  renderer.shaderManager.setShader(shader);

  // Update transform
  var tm = shader.uniforms.projectionMatrix;
  renderer.currentRenderTarget.projectionMatrix.copy(this.globalMat).append(this.worldTransform);
  tm.value = this.globalMat.toArray(true, matrixArrayCache);
  if (this.useSquare) {
    var ps = shader.uniforms.pointScale;
    ps.value[0] = this.globalMat.a >= 0 ? 1 : -1;
    ps.value[1] = this.globalMat.d &lt; 0 ? 1 : -1;
    ps = shader.uniforms.projectionScale;
    ps.value = Math.abs(this.worldTransform.a) * renderer.resolution;
  }
  shader.syncUniforms();

  // Won't render if tileset not set or no tile is inserted
  if (!this.tileset || !this.tileset.valid || (this.pointsBuf.length === 0)) return;

  // Bind tileset
  gl.activeTexture(gl.TEXTURE0);
  var tileset = this.tileset.baseTexture;
  if (!tileset._glTextures[gl.id]) {
    renderer.updateTexture(tileset);
  }
  else {
    gl.bindTexture(gl.TEXTURE_2D, tileset._glTextures[gl.id]);
  }
  var ss =  shader.uniforms.samplerSize;
  ss.value[0] = 1.0 / tileset.width;
  ss.value[1] = 1.0 / tileset.height;
  shader.syncUniform(ss);

  // Recover if context is lost
  var vb = tile.getVb(this.vbId);
  if (!vb) {
    vb = tile.createVb();
    this.vbId = vb.id;
    this.vbBuffer = null;
    this.modificationMarker = 0;
  }
  vb = vb.vb;

  // If layer was changed, reupload vertices
  var points = this.pointsBuf;
  shader.bindBuffer(gl, vb);
  var vertices = points.length / 6 * shader.vertPerQuad;
  if (this.modificationMarker !== vertices) {
    this.modificationMarker = vertices;
    var vs = shader.stride * vertices;
    if (!this.vbBuffer || this.vbBuffer.byteLength &lt; vs) {
      //!@#$
      var bk = shader.stride;
      while (bk &lt; vs) {
        bk *= 2;
      }
      this.vbBuffer = new ArrayBuffer(bk);
      this.vbArray = new Float32Array(this.vbBuffer);
      this.vbInts = new Uint32Array(this.vbBuffer);
      gl.bufferData(gl.ARRAY_BUFFER, this.vbArray, gl.DYNAMIC_DRAW);
    }

    var arr = this.vbArray, ints = this.vbInts;
    // Upload vertices!
    var sz = 0;
    if (this.useSquare) {
      for (var i = 0; i &lt; points.length; i += 6) {
        arr[sz++] = points[i + 2];
        arr[sz++] = points[i + 3];
        arr[sz++] = points[i + 0];
        arr[sz++] = points[i + 1];
        arr[sz++] = points[i + 4];
      }
    }
    else {
      var ww = tileset.width, hh = tileset.height;
      for (var i = 0; i &lt; points.length; i += 6) {
        var x = points[i+2], y = points[i+3];
        var w = points[i+4], h = points[i+5];
        var u = points[i], v = points[i+1];
        arr[sz++] = x;
        arr[sz++] = y;
        arr[sz++] = u;
        arr[sz++] = v;
        arr[sz++] = x + w;
        arr[sz++] = y;
        arr[sz++] = u + w;
        arr[sz++] = v;
        arr[sz++] = x + w;
        arr[sz++] = y + h;
        arr[sz++] = u + w;
        arr[sz++] = v + h;
        arr[sz++] = x;
        arr[sz++] = y;
        arr[sz++] = u;
        arr[sz++] = v;
        arr[sz++] = x + w;
        arr[sz++] = y + h;
        arr[sz++] = u + w;
        arr[sz++] = v + h;
        arr[sz++] = x;
        arr[sz++] = y + h;
        arr[sz++] = u;
        arr[sz++] = v + h;
      }
    }
    if (vs > this.vbArray.length / 2) {
      gl.bufferSubData(gl.ARRAY_BUFFER, 0, arr);
    }
    else {
      var view = arr.subarray(0, vs)
      gl.bufferSubData(gl.ARRAY_BUFFER, 0, view);
    }
  }
  if (this.useSquare) {
    gl.drawArrays(gl.POINTS, 0, vertices);
  }
  else {
    gl.drawArrays(gl.TRIANGLES, 0, vertices);
  }
};

/**
 * @exports engine/tilemap/background-map
 *
 * @see BackgroundMap
 *
 * @requires module:engine/pixi
 */
module.exports = exports = BackgroundMap;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>

	<span class="jsdoc-message">Made with ♥ by Sean Bohan</span>


	<span class="copyright">
	Lesser Panda Copyright © 2015-2016 The contributors to the Lesser Panda project.
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>
