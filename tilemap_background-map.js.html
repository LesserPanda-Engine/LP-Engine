<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Lesser Panda Source: tilemap/background-map.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.flatly.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Lesser Panda</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="module-engine_actor.html">engine/actor</a></li><li><a href="module-engine_analytics.html">engine/analytics</a></li><li><a href="module-engine_animation.html">engine/animation</a></li><li><a href="module-engine_animation_action.html">engine/animation/action</a></li><li><a href="module-engine_animation_easing.html">engine/animation/easing</a></li><li><a href="module-engine_animation_tween.html">engine/animation/tween</a></li><li><a href="module-engine_animation_utils.html">engine/animation/utils</a></li><li><a href="module-engine_audio.html">engine/audio</a></li><li><a href="module-engine_behavior.html">engine/behavior</a></li><li><a href="module-engine_camera.html">engine/camera</a></li><li><a href="module-engine_core.html">engine/core</a></li><li><a href="module-engine_device.html">engine/device</a></li><li><a href="module-engine_eventemitter3.html">engine/eventemitter3</a></li><li><a href="module-engine_keyboard.html">engine/keyboard</a></li><li><a href="module-engine_level_tiled-converter.html">engine/level/tiled-converter</a></li><li><a href="module-engine_level_utils.html">engine/level/utils</a></li><li><a href="module-engine_loader.html">engine/loader</a></li><li><a href="module-engine_physics.html">engine/physics</a></li><li><a href="module-engine_physics_spatial-hash.html">engine/physics/spatial-hash</a></li><li><a href="module-engine_renderer.html">engine/renderer</a></li><li><a href="module-engine_resize.html">engine/resize</a></li><li><a href="module-engine_rnd.html">engine/rnd</a></li><li><a href="module-engine_scene.html">engine/scene</a></li><li><a href="module-engine_storage.html">engine/storage</a></li><li><a href="module-engine_storage_data.html">engine/storage/data</a></li><li><a href="module-engine_storage_persistent-data.html">engine/storage/persistent-data</a></li><li><a href="module-engine_tilemap_background-map.html">engine/tilemap/background-map</a></li><li><a href="module-engine_tilemap_filmstrip.html">engine/tilemap/filmstrip</a></li><li><a href="module-engine_tilemap_tile-renderer.html">engine/tilemap/tile-renderer</a></li><li><a href="module-engine_timer.html">engine/timer</a></li><li><a href="module-engine_utils.html">engine/utils</a></li><li><a href="module-engine_vector.html">engine/vector</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu inline">
					<li><a href="Actor.html">Actor</a></li><li><a href="Analytics.html">Analytics</a></li><li><a href="BackgroundMap.html">BackgroundMap</a></li><li><a href="Behavior.html">Behavior</a></li><li><a href="Camera.html">Camera</a></li><li><a href="CollisionMap.html">CollisionMap</a></li><li><a href="Data.html">Data</a></li><li><a href="EventEmitter.html">EventEmitter</a></li><li><a href="Keyboard.html">Keyboard</a></li><li><a href="module-engine_animation_action-Action.html">engine/animation/action~Action</a></li><li><a href="module-engine_animation_action-ActionPlayer.html">engine/animation/action~ActionPlayer</a></li><li><a href="module-engine_animation_action-Channel.html">engine/animation/action~Channel</a></li><li><a href="module-engine_animation_action-Key.html">engine/animation/action~Key</a></li><li><a href="module-engine_physics-AABBSolver.html">engine/physics~AABBSolver</a></li><li><a href="module-engine_physics-Body.html">engine/physics~Body</a></li><li><a href="module-engine_physics-Box.html">engine/physics~Box</a></li><li><a href="module-engine_physics-Circle.html">engine/physics~Circle</a></li><li><a href="module-engine_physics-Polygon.html">engine/physics~Polygon</a></li><li><a href="module-engine_physics-SATSolver.html">engine/physics~SATSolver</a></li><li><a href="module-engine_physics-World.html">engine/physics~World</a></li><li><a href="PersistentData.html">PersistentData</a></li><li><a href="RandomDataGenerator.html">RandomDataGenerator</a></li><li><a href="Scene.html">Scene</a></li><li><a href="SpatialHash.html">SpatialHash</a></li><li><a href="Storage.html">Storage</a></li><li><a href="Timer.html">Timer</a></li><li><a href="Tween.html">Tween</a></li><li><a href="Vector.html">Vector</a></li>
				</ul>
			</li>
			
		</ul>
		<div class="col-sm-3 col-md-3">
            <form class="navbar-form" role="search">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                    <div class="input-group-btn">
                        <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                    </div>
                </div>
            </form>
        </div>
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: tilemap/background-map.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">var PIXI = require('engine/pixi');

var TileRenderer = require('./tile-renderer');
PIXI.WebGLRenderer.registerPlugin('tile', TileRenderer);

/**
 * @private
 */
function RectTileLayer(tilesize, texture) {
  PIXI.DisplayObject.call(this);

  // Initialize
  this.tilesize = tilesize;
  this.texture = texture;

  this.visible = false;

  this.pointsBuf = [];
  this.modificationMarker = 0;

  this.uOffset = texture.frame.x;
  this.vOffset = texture.frame.y;
  this.tilesPerTilesetRow = Math.floor(texture.width / tilesize);
}

RectTileLayer.prototype = Object.create(PIXI.DisplayObject.prototype);
RectTileLayer.prototype.constructor = RectTileLayer;

RectTileLayer.prototype.clear = function() {
  this.pointsBuf.length = 0;
  this.modificationMarker = 0;
};

RectTileLayer.prototype.renderCanvas = function(renderer) {
  if (!this.texture || !this.texture.valid) return;
  var points = this.pointsBuf;
  for (var i = 0, n = points.length; i &lt; n; i += 8) {
    var x1 = points[i], y1 = points[i+1];
    var x2 = points[i+2], y2 = points[i+3];
    var w = points[i+4];
    var h = points[i+5];
    x1 += points[i+6] * (renderer.tileAnimX | 0);
    y1 += points[i+7] * (renderer.tileAnimY | 0);
    renderer.context.drawImage(this.texture.baseTexture.source, x1, y1, w, h, x2, y2, w, h);
  }
};

RectTileLayer.prototype.addTile = function(tileIdx, tx, ty) {
  var pb = this.pointsBuf;
  pb.push(this.uOffset + this.tilesize * Math.floor(tileIdx % this.tilesPerTilesetRow));
  pb.push(this.vOffset + this.tilesize * Math.floor(tileIdx / this.tilesPerTilesetRow));
  pb.push(this.tilesize * tx);
  pb.push(this.tilesize * ty);
  pb.push(this.tilesize);
  pb.push(this.tilesize);
  pb.push(0);
  pb.push(0);
};

RectTileLayer.prototype.renderWebGL = function(renderer, useSquare) {
  if (!this.texture || !this.texture.valid) return;
  var points = this.pointsBuf;
  if (points.length === 0) return;

  var gl = renderer.gl;
  var tile = renderer.plugins.tile;
  var shader = tile.getShader(useSquare);
  gl.activeTexture(gl.TEXTURE0);
  var texture = this.texture.baseTexture;
  if (!texture._glTextures[gl.id]) {
    renderer.updateTexture(texture);
  }
  else {
    gl.bindTexture(gl.TEXTURE_2D, texture._glTextures[gl.id]);
  }
  var ss =  shader.uniforms.samplerSize;
  ss.value[0] = 1.0 / texture.width;
  ss.value[1] = 1.0 / texture.height;
  shader.syncUniform(ss);
  //lost context! recover!
  var vb = tile.getVb(this.vbId);
  if (!vb) {
    vb = tile.createVb();
    this.vbId = vb.id;
    this.vbBuffer = null;
    this.modificationMarker = 0;
  }
  vb = vb.vb;
  //if layer was changed, reupload vertices
  shader.bindBuffer(gl, vb);
  var vertices = points.length / 8 * shader.vertPerQuad;
  if (this.modificationMarker !== vertices) {
    this.modificationMarker = vertices;
    var vs = shader.stride * vertices;
    if (!this.vbBuffer || this.vbBuffer.byteLength &lt; vs) {
      //!@#$
      var bk = shader.stride;
      while (bk &lt; vs) {
        bk *= 2;
      }
      this.vbBuffer = new ArrayBuffer(bk);
      this.vbArray = new Float32Array(this.vbBuffer);
      this.vbInts = new Uint32Array(this.vbBuffer);
      gl.bufferData(gl.ARRAY_BUFFER, this.vbArray, gl.DYNAMIC_DRAW);
    }

    var arr = this.vbArray, ints = this.vbInts;
    //upload vertices!
    var sz = 0;
    //var tint = 0xffffffff;
    if (useSquare) {
      for (var i = 0; i &lt; points.length; i += 8) {
        arr[sz++] = points[i + 2];
        arr[sz++] = points[i + 3];
        arr[sz++] = points[i + 0];
        arr[sz++] = points[i + 1];
        arr[sz++] = points[i + 4];
        arr[sz++] = points[i + 6];
        arr[sz++] = points[i + 7];
      }
    }
    else {
      var ww = texture.width, hh = texture.height;
      //var tint = 0xffffffff;
      var tint = -1;
      for (var i = 0; i &lt; points.length; i += 8) {
        var x = points[i+2], y = points[i+3];
        var w = points[i+4], h = points[i+5];
        var u = points[i], v = points[i+1];
        var animX = points[i+6], animY = points[i+7];
        arr[sz++] = x;
        arr[sz++] = y;
        arr[sz++] = u;
        arr[sz++] = v;
        arr[sz++] = animX;
        arr[sz++] = animY;
        arr[sz++] = x + w;
        arr[sz++] = y;
        arr[sz++] = u + w;
        arr[sz++] = v;
        arr[sz++] = animX;
        arr[sz++] = animY;
        arr[sz++] = x + w;
        arr[sz++] = y + h;
        arr[sz++] = u + w;
        arr[sz++] = v + h;
        arr[sz++] = animX;
        arr[sz++] = animY;
        arr[sz++] = x;
        arr[sz++] = y;
        arr[sz++] = u;
        arr[sz++] = v;
        arr[sz++] = animX;
        arr[sz++] = animY;
        arr[sz++] = x + w;
        arr[sz++] = y + h;
        arr[sz++] = u + w;
        arr[sz++] = v + h;
        arr[sz++] = animX;
        arr[sz++] = animY;
        arr[sz++] = x;
        arr[sz++] = y + h;
        arr[sz++] = u;
        arr[sz++] = v + h;
        arr[sz++] = animX;
        arr[sz++] = animY;
      }
    }
    if (vs > this.vbArray.length/2 ) {
      gl.bufferSubData(gl.ARRAY_BUFFER, 0, arr);
    }
    else {
      var view = arr.subarray(0, vs)
      gl.bufferSubData(gl.ARRAY_BUFFER, 0, view);
    }
  }
  if (useSquare) {
    gl.drawArrays(gl.POINTS, 0, vertices);
  }
  else {
    gl.drawArrays(gl.TRIANGLES, 0, vertices);
  }
}

/**
 * TileMap for rendering rectangle tile based maps.
 *
 * Based on PIXI-tilemap by Ivan Popelyshev
 * Modified by Sean Bohan.
 *
 * @class BackgroundMap
 *
 * @constructor
 */
function BackgroundMap(tilesize, data, tileset) {
  PIXI.Container.call(this);

  this.useSquare = true;
  this.modificationMarker = 0;

  this.map = new RectTileLayer(tilesize, tileset);
  this.addChild(this.map);

  // Initialize
  this.tilesize = tilesize;
  this.data = data;
  this.tileset = tileset;

  // Create tiles from data
  var r, q, height = data.length, width = data[0].length, tileIdx;
  for (r = 0; r &lt; height; r++) {
    for (q = 0; q &lt; width; q++) {
      if (data[r][q] === 0) continue;
      this.map.addTile(data[r][q] - 1, q, r);
    }
  }
}

BackgroundMap.prototype = Object.create(PIXI.Container.prototype);
BackgroundMap.prototype.constructor = RectTileLayer;
BackgroundMap.prototype.updateTransform = BackgroundMap.prototype.displayObjectUpdateTransform;

/**
 * Clear the map
 * @memberof BackgroundMap#
 * @method clear
 */
BackgroundMap.prototype.clear = function() {
  this.children[0].clear();
  this.modificationMarker = 0;
};

/**
 * Add tile at a position(in tile grid)
 * @memberof BackgroundMap#
 * @method addTile
 */
BackgroundMap.prototype.addTile = function(tileIdx, tx, ty) {
  if (this.children[0].texture) {
    this.children[0].addTile(tileIdx, tx, ty);
  }
};

/**
 * Render to canvas context
 * @memberof BackgroundMap#
 * @method renderCanvas
 * @private
 */
BackgroundMap.prototype.renderCanvas = function(renderer) {
  if (!renderer.dontUseTransform) {
    var wt = this.worldTransform;
    renderer.context.setTransform(
      wt.a * renderer.resolution,
      wt.b,
      wt.c,
      wt.d * renderer.resolution,
      wt.tx * renderer.resolution,
      wt.ty * renderer.resolution
    );
  }
  var layers = this.children;
  for (var i = 0; i &lt; layers.length; i++) {
    layers[i].renderCanvas(renderer);
  }
};

/**
 * Render to WebGL context
 * @memberof BackgroundMap#
 * @method renderWebGL
 * @private
 */
BackgroundMap.prototype.renderWebGL = function(renderer) {
  var gl = renderer.gl;
  var shader = renderer.plugins.tile.getShader(this.useSquare);
  renderer.setObjectRenderer(renderer.plugins.tile);
  renderer.shaderManager.setShader(shader);
  var tm = shader.uniforms.projectionMatrix;
  //TODO: dont create new array, please
  this._globalMat = this._globalMat || new PIXI.Matrix();
  renderer.currentRenderTarget.projectionMatrix.copy(this._globalMat).append(this.worldTransform);
  tm.value = this._globalMat.toArray(true);
  if (this.useSquare) {
    var ps = shader.uniforms.pointScale;
    ps.value[0] = this._globalMat.a >= 0 ? 1 : -1;
    ps.value[1] = this._globalMat.d &lt; 0 ? 1 : -1;
    ps = shader.uniforms.projectionScale;
    ps.value = Math.abs(this.worldTransform.a) * renderer.resolution;
  }
  var af = shader.uniforms.animationFrame.value;
  af[0] = renderer.tileAnimX | 0;
  af[1] = renderer.tileAnimY | 0;
  //shader.syncUniform(shader.uniforms.animationFrame);
  shader.syncUniforms();
  var layers = this.children;
  for (var i = 0; i &lt; layers.length; i++) {
    layers[i].renderWebGL(renderer, this.useSquare);
  }
};

/**
 * Whether the map is modified (tiles are changed)
 * @memberof BackgroundMap#
 * @method isModified
 */
BackgroundMap.prototype.isModified = function(anim) {
  if (this.children[0].modificationMarker !== this.children[0].pointsBuf.length ||
    anim &amp;&amp; this.children[0].hasAnim) {
    return true;
  }
  return false;
};

/**
 * Set the tilemap as not modiried
 * @memberof BackgroundMap#
 * @method clearModify
 */
BackgroundMap.prototype.clearModify = function() {
  this.modificationMarker = this.children.length;
  this.children[0].modificationMarker = this.children[0].pointsBuf.length;
};

/**
 * @exports engine/tilemap/background-map
 *
 * @see BackgroundMap
 *
 * @requires module:engine/pixi
 */
module.exports = exports = BackgroundMap;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>

<div class="modal fade" id="searchResults">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search results</h4>
      </div>
      <div class="modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<footer>

	<span class="jsdoc-message">Made with ♥ by Sean Bohan</span>


	<span class="copyright">
	Lesser Panda Copyright © 2015-2016 The contributors to the Lesser Panda project.
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>
<script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>

<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			var id = $( heading ).attr( "id" );
			return id && id.replace(/\~/g, '-inner-').replace(/\./g, '-static-') || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->


<!--Google Analytics-->


<script type="text/javascript">
	$(document).ready(function() {
		SearcherDisplay.init();
	});
</script>

</body>
</html>
